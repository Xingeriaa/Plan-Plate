<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlannPlate - Nguyên Liệu Hữu Cơ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/styles.css" rel="stylesheet">
    <link href="css/animations.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="/js/search.js"></script>
    <link rel="icon" type="image/x-icon" href="/images/logo.png">
</head>
<body>

<header class="bg-light py-3">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center" style="cursor: pointer;" onclick="window.location.href='/'">
                <img src="images/logo.png" alt="PlannPlate Logo" class="me-3" style="width: 60px;">
                <h1>PlannPlate</h1>
            </div>

            <div class="flex-grow-1 mx-3 position-relative">
                <input type="text" class="form-control" id="searchInput" placeholder="Bạn đang tìm gì?">
                <div id="searchResults" class="search-results d-none position-absolute w-100 mt-1"></div>
            </div>

            <div class="d-flex align-items-center">
                <a href="#" class="btn btn-outline-primary me-3" id="accountBtn">Tài Khoản</a>
                <a href="#" class="btn btn-outline-primary position-relative" id="cartBtn">
                    Giỏ Hàng
                    <span class="badge bg-danger position-absolute top-0 start-100 translate-middle p-1 badge-circle" id="cartCount">0</span>
                </a>
            </div>
        </div>

<div class="account-sidebar" id="accountSidebar">
    <div class="account-sidebar-content">
        <div class="account-header">
            <h2>TÀI KHOẢN CỦA TÔI</h2>
            <button class="close-btn" id="closeSidebarBtn">&times;</button>
        </div>
        <div class="account-body">
            <a href="/login" class="btn btn-primary w-100 mb-3">ĐĂNG NHẬP</a>
            <a href="#" class="return-link" id="returnToStoreBtn">TRỞ LẠI CỬA HÀNG</a>
        </div>
    </div>
    <div class="sidebar-overlay" id="accountSidebarOverlay"></div>
</div>

<div class="cart-sidebar" id="cartSidebar">
    <div class="cart-sidebar-content">
        <div class="cart-header">
            <h2>XEM GIỎ HÀNG</h2>
            <button class="close-btn" id="closeCartBtn">&times;</button>
        </div>
        <div class="cart-body" id="cartItems">
        </div>
        <div class="cart-footer">
            <div class="cart-summary">
                <div class="d-flex justify-content-between mb-2">
                    <span>Tạm tính</span>
                    <span id="cartSubtotal">₫0</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Thuế <small>(tính khi thanh toán)</small></span>
                    <span>-</span>
                </div>
                <div class="d-flex justify-content-between mb-3">
                    <span>Phí vận chuyển</span>
                    <span>-</span>
                </div>
                <div class="shipping-note mb-3">
                    <small>Thuế, phí vận chuyển và khuyến mãi được tính khi thanh toán.</small>
                </div>
                <div class="mb-3">
                    <label for="cartNotes" class="form-label">Ghi chú giao hàng (Tùy chọn)</label>
                    <textarea class="form-control" id="cartNotes" rows="3"></textarea>
                </div>
                <div class="d-flex justify-content-between mb-3">
                    <span><strong>Tổng dự tính</strong></span>
                    <span id="cartTotal"><strong>₫0</strong></span>
                </div>
                <button class="btn btn-primary" id="checkoutBtn">THANH TOÁN</button>
            </div>
        </div>
    </div>
    <div class="sidebar-overlay" id="cartSidebarOverlay"></div>
</div>
        <nav class="navbar navbar-expand-lg navbar-light">
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav mx-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/product-listing.html">Tất Cả Sản Phẩm</a>
                    </li>
                    <!-- Update the bestsellers link in the navigation -->
                    <li class="nav-item">
                        <a class="nav-link" href="/bestsellers">Bán Chạy Nhất</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="about.html">Về Chúng Tôi</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="faq.html">Câu Hỏi Thường Gặp</a>
                    </li>
                </ul>
            </div>
        </nav>
    </div>
</header>

<section class="carousel-section mt-4">
    <div id="carouselExampleIndicators" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-indicators">
            <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>
            <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="1" aria-label="Slide 2"></button>
            <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="2" aria-label="Slide 3"></button>
            <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="3" aria-label="Slide 4"></button>
        </div>
        <div class="carousel-inner">
            <div class="carousel-item active">
                <img src="https://www.omfoods.com/cdn/shop/files/Banner_NEW.jpg?v=1681412890" class="d-block w-100" alt="Thực Phẩm Hữu Cơ">
            </div>
            <div class="carousel-item">
                <img src="https://www.omfoods.com/cdn/shop/files/OMFOODS_ORGANIC.jpg?v=1681412890" class="d-block w-100" alt="Thực Phẩm Hữu Cơ">
            </div>
            <div class="carousel-item">
                <img src="https://www.omfoods.com/cdn/shop/files/SALE_PRODUCTS_OM_FOODS.jpg?v=1681412890" class="d-block w-100" alt="Thực Phẩm Hữu Cơ">
            </div>
            <div class="carousel-item">
                <img src="https://www.omfoods.com/cdn/shop/files/OMFOODS_ORGANIC_INGREDIENTS.jpg?v=1681412891" class="d-block w-100 " alt="Thực Phẩm Hữu Cơ">
            </div>
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Trước</span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Tiếp</span>
        </button>
    </div>
</section>

<div class="section-divider"></div>

<!-- Update the products section title to be more descriptive -->
<section class="products-section mt-5 fade-in">
    <div class="container">
        <h2 class="text-center" style="font-weight: bold;">Khám Phá Tất Cả Danh Mục</h2>
        <p class="text-center text-muted mb-4">Khám phá đa dạng nguyên liệu hữu cơ cho lối sống lành mạnh của bạn</p>
        <div class="row" id="categoriesContainer">
            <!-- Categories will be loaded dynamically here -->
        </div>
    </div>
</section>

<div class="section-divider"></div>

<!-- Moved banner section below products section -->
<section class="banner-section mt-5 fade-in">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <div class="banner p-4 rounded" style="background-color: #f8f9fa; border-left: 5px solid #28a745;">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h3 class="mb-3">Nguyên Liệu Hữu Cơ Tươi Ngon Giao Tận Nhà</h3>
                            <p class="mb-3">Khám phá bộ sưu tập nguyên liệu hữu cơ cao cấp, được cung cấp bền vững. Từ trang trại đến bàn ăn, chúng tôi đảm bảo chất lượng trong mọi sản phẩm.</p>
                            <ul class="list-unstyled mb-0">
                                <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i> 100% Chứng Nhận Hữu Cơ</li>
                                <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i> Miễn Phí Vận Chuyển Cho Đơn Hàng Trên 1.000.000₫</li>
                                <li><i class="bi bi-check-circle-fill text-success me-2"></i> Đóng Gói Bền Vững</li>
                            </ul>
                        </div>
                        <div class="col-md-4 text-center text-md-end mt-3 mt-md-0">
                            <a href="/product-listing.html" class="btn btn-success btn-lg">Mua Ngay</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const accountBtn = document.getElementById('accountBtn');
        const accountSidebar = document.getElementById('accountSidebar');
        const closeSidebarBtn = document.getElementById('closeSidebarBtn');
        const accountSidebarOverlay = document.getElementById('accountSidebarOverlay');
        const returnToStoreBtn = document.getElementById('returnToStoreBtn');
        
        const cartBtn = document.getElementById('cartBtn');
        const cartSidebar = document.getElementById('cartSidebar');
        const closeCartBtn = document.getElementById('closeCartBtn');
        const cartSidebarOverlay = document.getElementById('cartSidebarOverlay');
        const cartItemsContainer = document.getElementById('cartItems');
        const cartSubtotal = document.getElementById('cartSubtotal');
        const cartTotal = document.getElementById('cartTotal');
        const checkoutBtn = document.getElementById('checkoutBtn');
        const cartCount = document.getElementById('cartCount');
        
        let cartItems = JSON.parse(localStorage.getItem('cartItems')) || [];
        
        function openSidebar() {
            accountSidebar.classList.add('active');
            accountSidebarOverlay.style.display = 'block';
            document.body.style.overflow = 'hidden'; 
        }
        
        function closeSidebar() {
            accountSidebar.classList.remove('active');
            accountSidebarOverlay.style.display = 'none';
            document.body.style.overflow = ''; 
        }
        
        function openCartSidebar() {
            cartSidebar.classList.add('active');
            cartSidebarOverlay.style.display = 'block';
            document.body.style.overflow = 'hidden'; 
            renderCartItems();
        }
        
        function closeCartSidebar() {
            cartSidebar.classList.remove('active');
            cartSidebarOverlay.style.display = 'none';
            document.body.style.overflow = '';
        }
        
        function checkAuthStatus() {
            return fetch('/auth/check', {
                method: 'GET',
                credentials: 'same-origin',
                headers: {
                    'Accept': 'application/json'
                }
            })
            .then(response => response.json())
            .catch(error => {
                console.error('Authentication check failed:', error);
                return { authenticated: false };
            });
        }
        
        function renderCartItems() {
            cartItemsContainer.innerHTML = '';
            
            if (cartItems.length === 0) {
                cartItemsContainer.innerHTML = '<p class="text-center my-5">Giỏ hàng của bạn đang trống</p>';
                cartSubtotal.textContent = '₫0';
                cartTotal.textContent = '₫0';
                return;
            }
            
            let subtotal = 0;
            
            cartItems.forEach((item, index) => {
                const price = parseFloat(item.price.replace('$', ''));
                const itemTotal = price * item.quantity;
                subtotal += itemTotal;
                
                const cartItemElement = document.createElement('div');
                cartItemElement.className = 'cart-item';
                cartItemElement.innerHTML = `
                    <div class="cart-item-image">
                        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="currentColor" class="bi bi-box" viewBox="0 0 16 16">
                            <path d="M8.186 1.113a.5.5 0 0 0-.372 0L1.846 3.5 8 5.961 14.154 3.5 8.186 1.113zM15 4.239l-6.5 2.6v7.922l6.5-2.6V4.24zM7.5 14.762V6.838L1 4.239v7.923l6.5 2.6zM7.443.184a1.5 1.5 0 0 1 1.114 0l7.129 2.852A.5.5 0 0 1 16 3.5v8.662a1 1 0 0 1-.629.928l-7.185 2.874a.5.5 0 0 1-.372 0L.63 13.09a1 1 0 0 1-.63-.928V3.5a.5.5 0 0 1 .314-.464L7.443.184z"/>
                        </svg>
                    </div>
                    <div class="cart-item-details">
                        <div class="cart-item-name">${item.name}</div>
                        <div class="cart-item-type">Loại</div>
                        <div class="cart-item-total">Tổng: ${item.price}</div>
                        <div class="cart-item-quantity">
                            <button class="quantity-btn minus-btn" data-index="${index}">-</button>
                            <input type="text" class="quantity-input" value="${item.quantity}" readonly>
                            <button class="quantity-btn plus-btn" data-index="${index}">+</button>
                        </div>
                        <a href="#" class="cart-item-remove" data-index="${index}">Xóa</a>
                    </div>
                `;
                
                cartItemsContainer.appendChild(cartItemElement);
            });
            
            cartSubtotal.textContent = '₫' + subtotal.toFixed(2);
            cartTotal.textContent = '₫' + subtotal.toFixed(2);

            document.querySelectorAll('.minus-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    if (cartItems[index].quantity > 1) {
                        cartItems[index].quantity -= 1;
                        updateCart();
                    }
                });
            });
            
            document.querySelectorAll('.plus-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    cartItems[index].quantity += 1;
                    updateCart();
                });
            });
            
            document.querySelectorAll('.cart-item-remove').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const index = parseInt(this.getAttribute('data-index'));
                    cartItems.splice(index, 1);
                    updateCart();
                });
            });
        }
        
        function updateCart() {
            localStorage.setItem('cartItems', JSON.stringify(cartItems));
            updateCartCount();
            renderCartItems();
        }
        
        function updateCartCount() {
            const totalItems = cartItems.reduce((total, item) => total + item.quantity, 0);
            cartCount.textContent = totalItems;
        }
        
        accountBtn.addEventListener('click', function(e) {
            e.preventDefault();
            
            checkAuthStatus().then(data => {
                if (data.authenticated) {
                    window.location.href = '/profile';
                } else {
                    openSidebar();
                }
            });
        });
        
        closeSidebarBtn.addEventListener('click', closeSidebar);
        accountSidebarOverlay.addEventListener('click', closeSidebar);
        returnToStoreBtn.addEventListener('click', function(e) {
            e.preventDefault();
            closeSidebar();
        });
        
        cartBtn.addEventListener('click', function(e) {
            e.preventDefault();
            openCartSidebar();
        });
        
        closeCartBtn.addEventListener('click', closeCartSidebar);
        cartSidebarOverlay.addEventListener('click', closeCartSidebar);
        
        checkoutBtn.addEventListener('click', function() {
            if (cartItems.length === 0) {
                alert('Giỏ hàng của bạn đang trống');
            } else {
                alert('Đang chuyển đến thanh toán...');
            }
        });
        
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (accountSidebar.classList.contains('active')) {
                    closeSidebar();
                }
                if (cartSidebar.classList.contains('active')) {
                    closeCartSidebar();
                }
            }
        });
        
        const searchInput = document.getElementById('searchInput');
        const searchResults = document.getElementById('searchResults');
        
        // Replace the existing search input event listener with this improved version
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            const query = this.value.trim();
            
            // Clear any existing timeout
            clearTimeout(searchTimeout);
            
            // Hide results if query is too short
            if (query.length < 3) {
                searchResults.classList.add('d-none');
                return;
            }
            
            // Show loading indicator
            searchResults.innerHTML = '<div class="text-center py-2"><div class="spinner-border spinner-border-sm text-primary" role="status"></div> Đang tìm kiếm...</div>';
            searchResults.classList.remove('d-none');
            
            // Set a timeout to delay the search request (debouncing)
            searchTimeout = setTimeout(() => {
                searchProducts(query);
            }, 300); // Wait 300ms after user stops typing
        });
        
        function searchProducts(query) {
            // Cache for search results
            if (!window.searchCache) {
                window.searchCache = {};
            }
            
            // Check if we have cached results for this query
            if (window.searchCache[query]) {
                displaySearchResults(window.searchCache[query]);
                return;
            }
            
            // Fetch products from API based on search query
            fetch(`/api/search?q=${encodeURIComponent(query)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Yêu cầu tìm kiếm thất bại');
                    }
                    return response.json();
                })
                .then(products => {
                    // Cache the results
                    window.searchCache[query] = products;
                    displaySearchResults(products);
                })
                .catch(error => {
                    console.error('Lỗi tìm kiếm:', error);
                    searchResults.innerHTML = '<div class="no-results p-3">Lỗi khi tìm kiếm sản phẩm. Vui lòng thử lại.</div>';
                });
        }
        
        function displaySearchResults(products) {
            searchResults.innerHTML = '';
            
            if (products.length === 0) {
                searchResults.innerHTML = '<div class="no-results">Không tìm thấy sản phẩm nào</div>';
                return;
            }
            
            // Display search results with enhanced UI
            products.forEach(product => {
                const resultItem = document.createElement('div');
                resultItem.className = 'search-result-item';
                
                // Format price with thousand separator
                const formattedPrice = new Intl.NumberFormat('vi-VN').format(product.Gia);
                
                resultItem.innerHTML = `
                    <div class="d-flex align-items-center">
                        <div class="search-result-img">
                            <img src="${product.HinhAnhSanPham || 'images/placeholder.png'}" alt="${product.TenSanPham}" onerror="this.src='images/placeholder.png'">
                        </div>
                        <div class="ms-3 flex-grow-1">
                            <div class="product-name">${product.TenSanPham}</div>
                            <span class="product-category">${product.TenDanhMuc || 'Sản phẩm'}</span>
                            <div class="product-price">${formattedPrice}₫</div>
                        </div>
                        <div class="ms-2">
                            <i class="bi bi-arrow-right text-muted"></i>
                        </div>
                    </div>
                `;
                
                resultItem.addEventListener('click', function() {
                    window.location.href = `/product.html?id=${product.IDSanPham}`;
                });
                
                searchResults.appendChild(resultItem);
            });
        }
        
        // Show loading indicator when searching
        searchInput.addEventListener('input', function() {
            const query = this.value.trim();
            
            // Clear any existing timeout
            clearTimeout(searchTimeout);
            
            // Hide results if query is too short
            if (query.length < 3) {
                searchResults.classList.add('d-none');
                return;
            }
            
            // Show loading indicator
            searchResults.innerHTML = '<div class="search-loading"><div class="spinner-border spinner-border-sm text-success me-2" role="status"></div> Đang tìm kiếm...</div>';
            searchResults.classList.remove('d-none');
            
            // Set a timeout to delay the search request (debouncing)
            searchTimeout = setTimeout(() => {
                searchProducts(query);
            }, 300); // Wait 300ms after user stops typing
        });
        
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                searchResults.classList.add('d-none');
            }
        });
        
        updateCartCount();
        
        // Add this function to fetch and display categories
        // Update the loadCategories function to fetch product counts
        function loadCategories() {
            fetch('/api/categories')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Phản hồi mạng không thành công');
                    }
                    return response.json();
                })
                .then(categories => {
                    const categoriesContainer = document.getElementById('categoriesContainer');
                    categoriesContainer.innerHTML = '';
                    
                    if (categories.length === 0) {
                        categoriesContainer.innerHTML = '<div class="col-12 text-center"><p>Không tìm thấy danh mục nào</p></div>';
                        return;
                    }
                    
                    // Create an array of promises for fetching product counts
                    const productCountPromises = categories.map(category => 
                        fetch(`/api/products/${category.IDDanhMuc}`)
                            .then(response => response.json())
                            .then(products => ({
                                category: category,
                                productCount: products.length
                            }))
                            .catch(error => ({
                                category: category,
                                productCount: 0
                            }))
                    );
                    
                    // Wait for all product count requests to complete
                    Promise.all(productCountPromises)
                        .then(categoriesWithCounts => {
                            categoriesWithCounts.forEach(({ category, productCount }) => {
                                const categoryCol = document.createElement('div');
                                categoryCol.className = 'col-md-4 col-lg-3 mb-4';
                                
                                categoryCol.innerHTML = `
                                    <div class="card h-100" data-category-id="${category.IDDanhMuc}" style="cursor: pointer;">
                                        <img src="${category.HinhAnhSanPham}" class="card-img-top" alt="${category.TenDanhMuc}">
                                        <div class="card-body">
                                            <h5 class="card-title">${category.TenDanhMuc.toUpperCase()}</h5>
                                            <p class="card-text">${productCount} SẢN PHẨM</p>
                                        </div>
                                    </div>
                                `;
                                
                                categoriesContainer.appendChild(categoryCol);
                            });
                            
                            // Re-attach event listeners to the new cards
                            const productCards = document.querySelectorAll('.card');
                            productCards.forEach(card => {
                                card.addEventListener('click', function() {
                                    const categoryId = this.getAttribute('data-category-id');
                                    const categoryName = this.querySelector('.card-title').textContent;
                                    
                                    // Redirect to product listing page with category ID
                                    window.location.href = `/product-listing.html?category=${categoryId}`;
                                });
                            });
                        });
                })
                .catch(error => {
                    console.error('Lỗi khi tải danh mục:', error);
                    document.getElementById('categoriesContainer').innerHTML = 
                        '<div class="col-12 text-center"><p>Không thể tải danh mục. Vui lòng thử lại sau.</p></div>';
                });
        }
        
        // Call this function in your DOMContentLoaded event
        loadCategories();
    });
</script>

<script src="js/sidebar.js"></script>

<!-- Add these scripts before the closing body tag -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
<script src="js/cart-service.js"></script>
<script src="js/sidebar.js"></script>
<script>
    // Remove the existing cart and account sidebar code from the inline script
    document.addEventListener('DOMContentLoaded', function() {
        // Load categories for the homepage
        fetch('/api/categories')
            .then(response => response.json())
            .then(categories => {
                const categoriesContainer = document.getElementById('categoriesContainer');
                if (categoriesContainer) {
                    let html = '';
                    categories.forEach(category => {
                        html += `
                            <div class="col-md-4 mb-4">
                                <div class="category-card">
                                    <img src="${category.HinhAnh || 'images/placeholder.png'}" alt="${category.TenDanhMuc}" class="category-image">
                                    <div class="category-overlay">
                                        <h3>${category.TenDanhMuc}</h3>
                                        <a href="/product-listing.html?category=${category.IDDanhMuc}" class="btn btn-outline-light">Xem Sản Phẩm</a>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    categoriesContainer.innerHTML = html;
                }
            })
            .catch(error => console.error('Error loading categories:', error));
    });
</script>
</body>
</html>